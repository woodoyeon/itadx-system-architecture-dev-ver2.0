# ItaDX — 아키텍처 전체 구조

> **한 줄 요약:** 은행이 마트 거래처의 신용을 평가하고 리스크를 실시간 모니터링하는 B2B SaaS 시스템

---

## 1. 시스템 개요

ItaDX는 마트 입고/거래 데이터를 기반으로 거래처의 **신용평가**와 **리스크 모니터링**을 수행하는 시스템입니다.  
마이크로서비스 아키텍처(MSA)로 구성되어 있으며, 각 서비스는 Docker 컨테이너로 독립 실행됩니다.

### 핵심 비즈니스 흐름

```
1. 마트 사용자가 입고확인 클릭
2. 비관적 잠금 + 트랜잭션으로 상태 변경
3. Bull Queue로 신용점수 재산출 (비동기)
4. WebSocket으로 은행에 실시간 알림
```

---

## 2. 전체 아키텍처 다이어그램

```
                                    https://itadx.co.kr
                                          │
                                     ┌────▼────┐
                                     │  NGINX  │  리버스 프록시 / WebSocket
                                     └────┬────┘
                                          │
                         ┌────────────────┼────────────────┐
                         │                │                │
                    ┌────▼────┐     ┌─────▼─────┐         │
                    │ USERS   │     │  API GW   │         │
                    │ Next.js │     │ Gateway   │         │
                    │ :3000   │     │ :4003     │         │
                    └─────────┘     └─────┬─────┘         │
                                          │                │
                    ┌─────────────────────┼────────────────┤
                    │                     │                │
              ┌─────▼─────┐       ┌──────▼──────┐  ┌─────▼─────┐
              │  AUTH-API  │       │  ADMIN-API  │  │  ERP-API  │
              │  인증/JWT   │       │  마트 CRUD   │  │ ★ 입고확인 │
              │  :4001     │       │  :4000      │  │  :4002    │
              └────────────┘       └──────┬──────┘  └─────┬─────┘
                                          │               │
                                          │         ┌─────▼─────┐
                                          │         │ BULL QUEUE │
                                          │         │ 비동기 신용평가│
                                          │         └─────┬─────┘
                                          │               │
              ┌────────────┐       ┌──────▼──────┐  ┌─────▼─────┐
              │   REDIS    │       │  POSTGRES   │  │ AI/ENGINE │
              │   :6379    │       │   :5432     │  │ Python    │
              │ JWT블랙리스트 │       │   메인 DB    │  │  :8000    │
              │ 큐 / Rate  │       └─────────────┘  └───────────┘
              └────────────┘                              │
                                                    ┌─────▼─────┐
                                                    │  ITANET   │
                                                    │  평가서버   │
                                                    │ v10: 신용평가│
                                                    │ v2: 마트심사 │
                                                    └───────────┘
```

---

## 3. 서비스 구성 (6개 서비스 + 3개 인프라)

### 3-1. 애플리케이션 서비스

| 서비스 | 포트 | 역할 | 기술 |
|--------|------|------|------|
| **admin-web** | 3000 | 프론트엔드 웹 애플리케이션 | Next.js 14.2, React 18.3, TypeScript 5.4 |
| **auth-api** | 4001 | JWT 인증 (로그인, 토큰 발급/갱신) | Nest.js 10.3, Passport, JWT |
| **admin-api** | 4000 | 마트/지점/가맹점 CRUD, 대시보드 | Nest.js 10.3, TypeORM 0.3.x |
| **erp-api** | 4002 | ★ 입고확인, 정산 (핵심 비즈니스) | Nest.js 10.3, TypeORM 0.3.x |
| **gateway-api** | 4003 | API 라우팅, 프록시, Rate Limit | Nest.js 10.3 |
| **engine-api** | 8000 | AI 신용평가 엔진 | Python 3.11, FastAPI 0.104.1 |

### 3-2. 인프라 서비스

| 서비스 | 포트 | 역할 |
|--------|------|------|
| **PostgreSQL 15** | 5432 | 메인 데이터베이스 (11개 테이블) |
| **Redis 7** | 6379 | JWT 블랙리스트, Bull Queue, Rate Limit 카운터 |
| **Nginx** | 80/443 | 리버스 프록시, WebSocket 업그레이드, SSL |

---

## 4. 서비스 간 통신 흐름

### 4-1. 프론트 → 백 (REST API)

```
브라우저 → Next.js (rewrite) → Gateway(:4003) → 각 서비스
```

- 프론트는 항상 `/api/...`만 호출
- Next.js가 Gateway(4003)로 rewrite
- Gateway가 URL prefix 보고 라우팅:
  - `/api/auth/*` → auth-api (4001)
  - `/api/marts/*`, `/api/users/*` → admin-api (4000)
  - `/api/receivings/*`, `/api/settlements/*` → erp-api (4002)

### 4-2. 백 → 프론트 (WebSocket 실시간)

```
erp-api → Bull Queue 완료 → WebSocket Gateway → 브라우저
```

- 입고확인 완료 시 신용점수 재산출 결과를 실시간 푸시
- 은행 대시보드에 실시간 알림

### 4-3. 백 → AI 엔진

```
erp-api → Bull Queue → credit-score.processor → engine-api(:8000)
```

- 입고확인 시 비동기로 신용평가 요청
- engine-api가 ITANET 평가서버와 통신하여 점수 산출

---

## 5. Gateway 라우팅 테이블

| URL Prefix | 대상 서비스 | 포트 | 설명 |
|------------|-----------|------|------|
| `/api/auth` | auth-api | 4001 | 로그인, 프로필, 토큰 갱신 |
| `/api/marts` | admin-api | 4000 | 마트 CRUD |
| `/api/users` | admin-api | 4000 | 사용자 관리 |
| `/api/receivings` | erp-api | 4002 | 입고 목록, 입고확인 |
| `/api/settlements` | erp-api | 4002 | 정산 관리 |

---

## 6. 데이터 흐름 예시: 입고확인

```
[마트 담당자]
    │
    │ 1. "입고확인" 클릭
    ▼
[admin-web :3000]
    │ api.patch('/receivings/uuid-123/confirm')
    ▼
[Next.js rewrite]
    │ → http://localhost:4003/api/receivings/uuid-123/confirm
    ▼
[gateway-api :4003]
    │ /api/receivings → erp-api(4002)로 프록시
    ▼
[erp-api :4002]
    │ 1) 비관적 잠금(SELECT FOR UPDATE)
    │ 2) status: pending → confirmed
    │ 3) Bull Queue에 신용평가 작업 추가
    ▼
[Bull Queue + Redis]
    │ credit-score.processor 가 비동기 처리
    ▼
[engine-api :8000]
    │ v10_service.py → ITANET 평가서버 호출
    │ 신용점수 계산 후 DB 저장
    ▼
[WebSocket Gateway]
    │ 은행 대시보드에 실시간 알림 전송
    ▼
[은행 담당자 브라우저]
    신용점수 갱신 확인
```

---

## 7. 보안 구조

| 계층 | 방식 | 설명 |
|------|------|------|
| **인증** | JWT (Access + Refresh Token) | Passport 기반, 모든 API 요청에 Bearer 토큰 필수 |
| **인가** | Roles Guard | 역할별 접근 제어 (@Roles 데코레이터) |
| **토큰 무효화** | Redis 블랙리스트 | 로그아웃 시 토큰 즉시 무효화 |
| **API 보호** | Rate Limit | Redis 기반 요청 속도 제한 |
| **감사** | Audit Log | libs/audit로 모든 주요 행위 자동 기록 |
| **네트워크** | Nginx + HTTPS | SSL 종단, 리버스 프록시 |

---

## 8. 배포 환경

| 항목 | 설정 |
|------|------|
| **컨테이너** | Docker Compose (전체 서비스 한 번에 실행) |
| **모노레포** | pnpm workspace (패키지 공유, 의존성 효율화) |
| **프록시** | Nginx (SSL, 로드밸런싱, WebSocket 업그레이드) |
| **도메인** | https://itadx.co.kr |
